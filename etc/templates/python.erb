<% if header? %>
# <%= FFIDB.header %>

<% end %>
import ctypes, ctypes.util

<%= @library.name %> = ctypes.CDLL(
<% self.dlopen_paths_for(@library).each_with_index do |library_path, i| %>
    <%= i.nonzero? ? 'or ' : '' %>ctypes.util.find_library("<%= library_path %>")
<% end %>
<% unless options[:library_path] %>
    or "<%= @library.dlopen.first %>"
<% end %>
)
<% for enum in @enums || [] %>

<% if enum.comment %>
# <%= enum.comment %>
<% end %>
<%= enum.name %> = ctypes.c_int
<% for name, value in enum.values || {} %>
<%= name %> = <%= value %>
<% end %>
<% end %>
<% for struct in @structs || [] %>

<% if struct.comment %>
# <%= struct.comment %>
<% end %>
class <%= struct.name %>(Structure):
  <% if struct.fields.nil? || struct.fields.empty? %>
    _fields_ = []
  <% else %>
    _fields_ = [
    <% for name, type in struct.fields || {} %>
        (<%= name.to_s.inspect %>, <%= format_type(type) %>),  # <%= type %>
    <% end %>
    ]
  <% end %>
<% end %>
<% for function in @functions || [] %>

<% if function.comment %>
# <%= function.comment %>
<% end %>
<%= function.name %> = <%= @library.name %>.<%= function.name %>
<%= function.name %>.restype = <%= format_type(function.type) %>
<%= function.name %>.argtypes = [<%=
  function.parameters.each_value.map { |p| format_type(p.type) }.join(', ')
%>]
<% end %>
